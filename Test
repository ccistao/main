-- Auto Hack PC Script for Flee the Facility
-- Final Version with GUI Toggle

local player = game.Players.LocalPlayer
local Players = game:GetService("Players")
local character = player.Character or player.CharacterAdded:Wait()
local humanoid = character:WaitForChild("Humanoid")
local rootPart = character:WaitForChild("HumanoidRootPart")
local Replicated = game:GetService("ReplicatedStorage")

-- Settings
local scriptEnabled = false
local hackDelay = 5
local waitBeforeHack = 1
local currentPC = nil
local isHacking = false
local hackedPCs = {}
local beast = nil
local foundBeast = false
local skipCurrentPC = false

-- H√†m log
local function log(message)
    print("[AUTO HACK] " .. tostring(message))
end

-- H√†m ki·ªÉm tra player c√≥ ph·∫£i Beast kh√¥ng
local function isBeast(plr)
    if not plr then return false end
    local s = plr:FindFirstChild("TempPlayerStatsModule")
    return s and s:FindFirstChild("IsBeast") and s.IsBeast.Value
end

-- H√†m t√¨m Beast
local function findBeast()
    task.spawn(function()
        local runningScan = false
        if runningScan then return end
        runningScan = true
        
        while task.wait(0.05) do
            -- Ki·ªÉm tra Beast hi·ªán t·∫°i c√≤n h·ª£p l·ªá kh√¥ng
            if foundBeast then
                if not beast or not Players:FindFirstChild(beast.Name) or not isBeast(beast) then
                    beast, foundBeast = nil, false
                    log("‚ö†Ô∏è Beast ƒë√£ m·∫•t!")
                end
            end
            
            -- T√¨m Beast m·ªõi
            if not foundBeast then
                for _, p in ipairs(Players:GetPlayers()) do
                    if isBeast(p) then
                        beast, foundBeast = p, true
                        log("üëπ PH√ÅT HI·ªÜN BEAST: " .. beast.Name)
                        break
                    end
                end
            end
        end
    end)
end

-- H√†m ki·ªÉm tra Beast c√≥ g·∫ßn kh√¥ng (20 studs)
local function isBeastNearby()
    if not foundBeast or not beast or not beast.Character then return false end
    
    local beastRoot = beast.Character:FindFirstChild("HumanoidRootPart")
    if not beastRoot or not rootPart then return false end
    
    local distance = (rootPart.Position - beastRoot.Position).Magnitude
    return distance <= 20 -- TƒÉng l√™n 20 studs
end

-- H√†m tr·ªën Beast (tp xu·ªëng ƒë·∫•t -35)
local function escapeBeast()
    log("üö® BEAST ·ªû G·∫¶N! TR·ªêN XU·ªêNG ƒê·∫§T!")
    
    -- L∆∞u v·ªã tr√≠ hi·ªán t·∫°i
    local currentPos = rootPart.CFrame.Position
    
    -- Teleprt xu·ªëng ƒë·∫•t (Y - 35)
    rootPart.CFrame = CFrame.new(currentPos.X, currentPos.Y - 35, currentPos.Z)
    
    -- ƒê√°nh d·∫•u b·ªè PC hi·ªán t·∫°i
    skipCurrentPC = true
    
    log("‚è≥ Ch·ªù 2s...")
    task.wait(2)
    
    log("‚úì An to√†n! T√¨m PC kh√°c...")
end
spawn(function()
    local playerGui = player:WaitForChild("PlayerGui")
    local screenGui = playerGui:WaitForChild("ScreenGui")
    local actionBox = screenGui:WaitForChild("ActionBox")
    
    actionBox:GetPropertyChangedSignal("Visible"):Connect(function()
        if scriptEnabled and actionBox.Visible then
            -- Ki·ªÉm tra xem c√≥ ƒëang ·ªü g·∫ßn PC kh√¥ng
            if isHacking and currentPC then
                log("üîß Auto interact PC!")
                game.ReplicatedStorage.RemoteEvent:FireServer("Input", "Action", true)
            end
        end
    end)
    
    log("‚úì Auto interact loaded")
end)

-- H√†m ch·ªù game active
local function waitForGameActive()
    log("ƒêang ch·ªù game active...")
    local gameActive = Replicated:WaitForChild("IsGameActive", 10)
    
    if gameActive and gameActive:IsA("BoolValue") then
        repeat 
            task.wait(0.5) 
        until gameActive.Value == true
        
        log("‚úì Game ƒë√£ active!")
        return true
    else
        log("‚úó Kh√¥ng t√¨m th·∫•y IsGameActive")
        return false
    end
end

local function getProgressValue(computerTable)
    for _, child in ipairs(computerTable:GetDescendants()) do
        if (child.Name == "ActionProgress" or child.Name == "Value") and (child:IsA("IntValue") or child:IsA("NumberValue")) then
            return child.Value
        end
        
        -- M·ªôt s·ªë map d√πng ActionProgress.Value (value l·ªìng)
        if child:IsA("Folder") and child:FindFirstChild("Value") then
            local v = child:FindFirstChild("Value")
            if v:IsA("IntValue") or v:IsA("NumberValue") then
                return v.Value
            end
        end
    end
    return nil
end

local function isValidPC(computerTable)
    if not computerTable then return false end
    
    -- T√¨m Trigger
    local hasTrigger = false
    for _, child in ipairs(computerTable:GetChildren()) do
        if child:IsA("BasePart") and child.Name:match("ComputerTrigger") then
            hasTrigger = true
            break
        end
    end
    if not hasTrigger then return false end

    -- T√¨m Progress
    local val = getProgressValue(computerTable)
    if val == nil then 
        log("‚ùå Progress nil ‚Üí b·ªè PC")
        return false 
    end

    return true
end


-- H√†m t√¨m t·∫•t c·∫£ PC triggers (M·ªói 3 trigger = 1 PC) v·ªõi filter
local function findAllPCTriggers()
    local pcGroups = {}
    local allPCs = {}

    for _, obj in ipairs(workspace:GetDescendants()) do
        if obj:IsA("BasePart") and obj.Name:match("ComputerTrigger") then
            local computer = obj.Parent
            if computer then
                if not pcGroups[computer] then
                    pcGroups[computer] = { computer = computer, triggers = {} }
                end
                table.insert(pcGroups[computer].triggers, obj)
            end
        end
    end

    for comp, data in pairs(pcGroups) do
        if isValidPC(comp) then
            table.insert(allPCs, {
                trigger = data.triggers[1],
                computer = comp,
                id = comp -- d√πng instance l√†m ID
            })
        end
    end

    return allPCs
end

-- H√†m ki·ªÉm tra PC done (t·ªëi ∆∞u, check nhanh)
local function isPCDone(pcData)
    if not pcData or not pcData.computer then return false end
    
    -- Check nhanh c√°c child c·ªßa computer
    for _, child in pairs(pcData.computer:GetChildren()) do
        if (child.Name == "ActionProgress" or child.Name == "Value") and 
           (child:IsA("IntValue") or child:IsA("NumberValue")) then
            if child.Value >= 1 then
                return true
            end
        end
    end
    
    -- Check trong c√°c triggers
    for _, child in pairs(pcData.computer:GetDescendants()) do
        if (child.Name == "ActionProgress" or child.Name == "Value") and 
           (child:IsA("IntValue") or child:IsA("NumberValue")) then
            if child.Value >= 1 then
                return true
            end
        end
    end
    
    return false
end

-- H√†m theo d√µi progress
local function trackPCProgress(pcData)
    if not pcData or not pcData.computer then return end
    
    for _, child in pairs(pcData.computer:GetDescendants()) do
        if child.Name == "ActionProgress" or child.Name == "Value" then
            if child:IsA("IntValue") or child:IsA("NumberValue") then
                log("üìä Tracking: " .. child:GetFullName())
                
                child:GetPropertyChangedSignal("Value"):Connect(function()
                    local progress = math.floor(child.Value * 100)
                    log("Progress: " .. progress .. "%")
                    
                    if child.Value >= 1 then
                        log("‚úÖ PC DONE!")
                    end
                end)
            end
        end
    end
end

-- H√†m teleport
local function teleportToTrigger(triggerPart)
    if not triggerPart or not rootPart then return false end
    
    log("Teleporting to: " .. triggerPart.Name)
    rootPart.CFrame = triggerPart.CFrame + Vector3.new(0, 3, 0)
    task.wait(0.5)
    return true
end

-- H√†m k√≠ch ho·∫°t hack (fire remote)
local function activateHack(pcData)
    if not pcData or not pcData.trigger then return false end
    
    log("K√≠ch ho·∫°t hack (FireServer)...")
    
    -- Fire remote ƒë·ªÉ hack
    pcall(function()
        game.ReplicatedStorage.RemoteEvent:FireServer("Input", "Action", true)
    end)
    
    -- Touch trigger ƒë·ªÉ hi·ªán ActionBox
    pcall(function()
        firetouchinterest(pcData.trigger, rootPart, 0)
        task.wait(0.05)
        firetouchinterest(pcData.trigger, rootPart, 1)
    end)
    
    return true
end

-- H√†m hack PC v·ªõi check done tr∆∞·ªõc
local function hackPC(pcData)
    if not pcData or isHacking then return end
    
    -- CHECK DONE TR∆Ø·ªöC KHI L√ÄM G√å C·∫¢
    if isPCDone(pcData) then
        log("‚è≠Ô∏è PC " .. pcData.computer.Name .. " ƒë√£ done, skip!")
        hackedPCs[pcData.id] = true
        return
    end
    
    isHacking = true
    currentPC = pcData
    skipCurrentPC = false
    log("=== B·∫ÆT ƒê·∫¶U HACK PC: " .. pcData.computer.Name .. " ===")
    
    trackPCProgress(pcData)
    
    if not teleportToTrigger(pcData.trigger) then
        log("‚úó Teleport th·∫•t b·∫°i!")
        isHacking = false
        currentPC = nil
        return
    end
    
    -- CHECK DONE SAU KHI TP (c√≥ th·ªÉ ai ƒë√≥ v·ª´a hack xong)
    if isPCDone(pcData) then
        log("‚è≠Ô∏è PC v·ª´a ƒë∆∞·ª£c hack xong, skip!")
        hackedPCs[pcData.id] = true
        isHacking = false
        currentPC = nil
        return
    end
    
    task.wait(waitBeforeHack)
    
    log("K√≠ch ho·∫°t hack l·∫ßn ƒë·∫ßu...")
    activateHack(pcData)
    
    local maxHackTime = 60
    local hackStartTime = tick()
    local lastJumpTime = tick()
    local checkInterval = 0 -- ƒê·∫øm ƒë·ªÉ check done th∆∞·ªùng xuy√™n
    
    while scriptEnabled and not isPCDone(pcData) and not skipCurrentPC and (tick() - hackStartTime < maxHackTime) do
        -- KI·ªÇM TRA BEAST G·∫¶N
        if isBeastNearby() then
            escapeBeast()
            break
        end
        
        -- Check done m·ªói 1s (nhanh h∆°n)
        checkInterval = checkInterval + 1
        if checkInterval >= 2 then -- M·ªói 0.5s * 2 = 1s
            if isPCDone(pcData) then
                log("‚úì PC done trong khi hack!")
                break
            end
            checkInterval = 0
        end
        
        if tick() - lastJumpTime >= hackDelay then
            log("Jumping...")
            humanoid:ChangeState(Enum.HumanoidStateType.Jumping)
            task.wait(0.3)
            
            rootPart.CFrame = pcData.trigger.CFrame + Vector3.new(0, 3, 0)
            task.wait(0.2)
            
            log("K√≠ch ho·∫°t hack sau jump...")
            activateHack(pcData)
            
            lastJumpTime = tick()
        end
        
        task.wait(0.5)
    end
    
    if skipCurrentPC then
        log("=== ‚ö†Ô∏è B·ªé PC N√ÄY (Beast g·∫ßn)! ===")
    elseif isPCDone(pcData) then
        log("=== ‚úÖ PC HO√ÄN T·∫§T! ===")
        hackedPCs[pcData.id] = true
    else
        log("=== ‚è±Ô∏è TIMEOUT! ===")
    end
    
    isHacking = false
    currentPC = nil
    task.wait(0.5) -- Gi·∫£m delay t·ª´ 1s xu·ªëng 0.5s
end

-- Main loop
local function mainLoop()
    log("üöÄ AUTO HACK ƒêANG CH·∫†Y!")
    
    while true do
        if scriptEnabled then
            if not waitForGameActive() then
                task.wait(10)
            else
                hackedPCs = {}
                log("üÜï Game m·ªõi! Reset PC list")
                
                local allPCs = findAllPCTriggers()
                
                if #allPCs == 0 then
                    log("‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y PC!")
                    task.wait(3)
                else
                    log("T√¨m th·∫•y " .. #allPCs .. " PC(s)")
                    
                    for _, pcData in ipairs(allPCs) do
                        if not scriptEnabled then break end
                        hackPC(pcData)
                    end
                    
                    log("‚úÖ Ho√†n t·∫•t! Ch·ªù game m·ªõi...")
                end
            end
        else
            task.wait(2)
        end
    end
end

-- T·∫°o GUI Toggle Button
local function createGUI()
    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "AutoHackGUI"
    screenGui.ResetOnSpawn = false
    screenGui.Parent = player:WaitForChild("PlayerGui")
    
    local frame = Instance.new("Frame")
    frame.Size = UDim2.new(0, 200, 0, 80)
    frame.Position = UDim2.new(0.5, -100, 0, 20)
    frame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    frame.BorderSizePixel = 2
    frame.BorderColor3 = Color3.fromRGB(255, 255, 255)
    frame.Parent = screenGui
    
    local uiCorner = Instance.new("UICorner")
    uiCorner.CornerRadius = UDim.new(0, 8)
    uiCorner.Parent = frame
    
    local title = Instance.new("TextLabel")
    title.Size = UDim2.new(1, 0, 0, 25)
    title.Position = UDim2.new(0, 0, 0, 0)
    title.BackgroundTransparency = 1
    title.Text = "AUTO HACK PC"
    title.TextColor3 = Color3.fromRGB(255, 255, 255)
    title.TextSize = 14
    title.Font = Enum.Font.GothamBold
    title.Parent = frame
    
    local toggleButton = Instance.new("TextButton")
    toggleButton.Size = UDim2.new(0, 160, 0, 35)
    toggleButton.Position = UDim2.new(0.5, -80, 0, 35)
    toggleButton.BackgroundColor3 = Color3.fromRGB(220, 50, 50)
    toggleButton.Text = "T·∫ÆT"
    toggleButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    toggleButton.TextSize = 16
    toggleButton.Font = Enum.Font.GothamBold
    toggleButton.Parent = frame
    
    local btnCorner = Instance.new("UICorner")
    btnCorner.CornerRadius = UDim.new(0, 6)
    btnCorner.Parent = toggleButton
    
    -- Toggle function
    toggleButton.MouseButton1Click:Connect(function()
        scriptEnabled = not scriptEnabled
        
        if scriptEnabled then
            toggleButton.BackgroundColor3 = Color3.fromRGB(50, 220, 50)
            toggleButton.Text = "B·∫¨T"
            log("‚úì AUTO HACK: B·∫¨T")
        else
            toggleButton.BackgroundColor3 = Color3.fromRGB(220, 50, 50)
            toggleButton.Text = "T·∫ÆT"
            log("‚úó AUTO HACK: T·∫ÆT")
        end
    end)
    
    -- Draggable
    local UIS = game:GetService("UserInputService")

    local dragging = false
    local dragStart
    local startPos

    frame.InputBegan:Connect(function(input)   
        if input.UserInputType == Enum.UserInputType.MouseButton1 
        or input.UserInputType == Enum.UserInputType.Touch then
            dragging = true
            dragStart = input.Position
            startPos = frame.Position
        end
    end)

    frame.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1
        or input.UserInputType == Enum.UserInputType.Touch then
            dragging = false
        end
    end)

    UIS.InputChanged:Connect(function(input)
        if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement 
            or input.UserInputType == Enum.UserInputType.Touch) then
            local delta = input.Position - dragStart
            frame.Position = UDim2.new(
                startPos.X.Scale,
                startPos.X.Offset + delta.X,
                startPos.Y.Scale,
                startPos.Y.Offset + delta.Y
            )
        end
    end)
    log("‚úì GUI created!")
end

-- Kh·ªüi ƒë·ªông
log("===============================")
log("AUTO HACK PC - FLEE THE FACILITY")
log("===============================")
createGUI()
findBeast() -- B·∫Øt ƒë·∫ßu t√¨m Beast
task.spawn(mainLoop)
log("‚úì Script loaded! B·∫•m n√∫t ƒë·ªÉ b·∫≠t/t·∫Øt")
log("‚úì Anti-Beast: B·∫¨T (tr·ªën khi Beast < 20 studs, tp xu·ªëng -35)")
