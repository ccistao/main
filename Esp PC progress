local Players = game:GetService("Players")
local Replicated = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local UIS = game:GetService("UserInputService")
local StarterGui = game:GetService("StarterGui")

local plr = Players.LocalPlayer

local TOGGLE_KEY = Enum.KeyCode.Insert
local pcProgressRunning = false
local pcConnections = {}

local function Notify(msg)
    pcall(function()
        StarterGui:SetCore("SendNotification", {
            Title = "PC Progress";
            Text = msg;
            Duration = 2;
        })
    end)
end

local function disconnectPCProgress()
    for _,c in ipairs(pcConnections) do
        if typeof(c) == "RBXScriptConnection" then
            c:Disconnect()
        end
    end
    pcConnections = {}
end

local function stopPCProgress()
    pcProgressRunning = false
    disconnectPCProgress()
    
    for _,v in pairs(workspace:GetDescendants()) do
        if v:IsA("BillboardGui") and v.Name == "PCProgressBB" then
            v.Enabled = false
        end
    end
end

local function startPCProgress()
    if pcProgressRunning then return end
    pcProgressRunning = true

    for _,v in pairs(workspace:GetDescendants()) do
        if v:IsA("BillboardGui") and v.Name == "PCProgressBB" then
            v.Enabled = true
        end
    end

    local pcLabels, finished, pcState, hookedPCs, lastPercent = {}, {}, {}, {}, {}
    local pendingUpdate = {}
    local UPDATE_INTERVAL = 0.1

    local function findAttachPart(pc)
        if pc:IsA("Model") then
            local scr = pc:FindFirstChild("Screen")
            if scr and scr:IsA("BasePart") then return scr end
            if pc.PrimaryPart then return pc.PrimaryPart end
            for _,d in ipairs(pc:GetDescendants()) do
                if d:IsA("BasePart") then return d end
            end
        elseif pc:IsA("BasePart") then
            return pc
        end
        return nil
    end

    local function createBillboard(pc)
        if pcLabels[pc] then return pcLabels[pc] end
        local part = findAttachPart(pc)
        if not part then return end
        
        local existingBB = part:FindFirstChild("PCProgressBB")
        if existingBB then
            existingBB.Enabled = true
            local tl = existingBB:FindFirstChildOfClass("TextLabel")
            if tl then
                pcLabels[pc] = {label = tl, bb = existingBB, part = part}
                lastPercent[pc] = 0
                return pcLabels[pc]
            end
        end
        
        local bb = Instance.new("BillboardGui")
        bb.Name = "PCProgressBB"
        bb.Size = UDim2.new(0, 60, 0, 25)
        bb.StudsOffset = Vector3.new(0, 2, 0)
        bb.AlwaysOnTop = true
        bb.Adornee = part
        bb.Parent = part
        
        local tl = Instance.new("TextLabel")
        tl.Size = UDim2.new(1,0,1,0)
        tl.BackgroundTransparency = 1
        tl.TextColor3 = Color3.new(1,1,1)
        tl.Font = Enum.Font.GothamBold
        tl.TextScaled = true
        tl.Text = "0%"
        tl.Visible = true
        tl.Parent = bb
        
        pcLabels[pc] = {label = tl, bb = bb, part = part}
        lastPercent[pc] = 0
        return pcLabels[pc]
    end

    local function clearAll()
        for _,v in pairs(pcLabels) do
            if v.bb then v.bb.Enabled = false end
        end
        pcLabels, finished, pcState, hookedPCs, lastPercent, pendingUpdate = {}, {}, {}, {}, {}, {}
    end

    local function queueProgress(pc, value)
        if finished[pc] then return end
        if pcState[pc] == "DONE" then return end
        
        local percent = math.floor(value * 100 + 0.5)
        if percent >= 100 then
            percent = 100
            finished[pc] = true
        end
        if percent ~= (lastPercent[pc] or -1) then
            if percent == 0 and (lastPercent[pc] or 0) > 0 then
                return
            end
            lastPercent[pc] = percent
            pendingUpdate[pc] = tostring(percent).."%"
        end
    end

    table.insert(pcConnections, task.spawn(function()
        while pcProgressRunning do
            for pc,text in pairs(pendingUpdate) do
                local pack = createBillboard(pc)
                if pack then
                    if pack.label.Text ~= text then
                        pack.label.Text = text
                        pack.label.TextColor3 = Color3.new(1,1,1)
                    end
                end
                pendingUpdate[pc] = nil
            end
            task.wait(UPDATE_INTERVAL)
        end
    end))

    local function nearestPC(pos, maxDist)
        local best,bd = nil, maxDist or 30
        for pc,_ in pairs(pcLabels) do
            local part = pcLabels[pc].part
            if part then
                local dist = (part.Position - pos).Magnitude
                if dist < bd then
                    best, bd = pc, dist
                end
            end
        end
        return best
    end

    local function onActionProgress(player, value)
        local tps = player:FindFirstChild("TempPlayerStatsModule")
        if not tps then return end
        local currentAnim = tps:FindFirstChild("CurrentAnimation")
        if not currentAnim or currentAnim.Value ~= "Typing" then return end
        if not player.Character then return end
        local hrp = player.Character:FindFirstChild("HumanoidRootPart")
        if not hrp then return end
        local pc = nearestPC(hrp.Position, 35)
        if pc then
            queueProgress(pc, value)
        end
    end

    local function hookPlayer(player)
        local function attach(c)
            if c.Name == "TempPlayerStatsModule" then
                local ap = c:WaitForChild("ActionProgress", 10)
                if ap and ap:IsA("NumberValue") then
                    table.insert(pcConnections, ap:GetPropertyChangedSignal("Value"):Connect(function()
                        onActionProgress(player, ap.Value)
                    end))
                end
            end
        end
        player.ChildAdded:Connect(attach)
        local tps = player:FindFirstChild("TempPlayerStatsModule")
        if tps then attach(tps) end
    end
    for _,p in ipairs(Players:GetPlayers()) do hookPlayer(p) end
    table.insert(pcConnections, Players.PlayerAdded:Connect(hookPlayer))

    local function applyScreenState(pc, c)
        local pack = createBillboard(pc)
        if not pack then return end
        
        if c.G > c.R + 0.2 and c.G > c.B + 0.2 then
            pcState[pc] = "DONE"
            pack.label.Text = "DONE"
            pack.label.TextColor3 = Color3.new(0,1,0)
        else
            if not finished[pc] then
                pcState[pc] = nil
                pack.label.TextColor3 = Color3.new(1,1,1)
            end
        end
    end
    
    local function watchPC(pc)
        if hookedPCs[pc] then return end
        hookedPCs[pc] = true
        local scr = pc:FindFirstChild("Screen")
        if scr and scr:IsA("BasePart") then
            applyScreenState(pc, scr.Color)
            table.insert(pcConnections, scr:GetPropertyChangedSignal("Color"):Connect(function()
                applyScreenState(pc, scr.Color)
            end))
        end
    end

    table.insert(pcConnections, task.spawn(function()
        while pcProgressRunning do
            local map = Replicated:FindFirstChild("CurrentMap") and Replicated.CurrentMap.Value
            if map then
                for _,d in ipairs(map:GetDescendants()) do
                    if d.Name == "ComputerTable" then
                        createBillboard(d)
                        watchPC(d)
                    end
                end
            end
            task.wait(1)
        end
    end))

    table.insert(pcConnections, RunService.RenderStepped:Connect(function()
        for _, pack in pairs(pcLabels) do
            if pack.label then
                pack.label.Visible = true
            end
        end
    end))

    if Replicated:FindFirstChild("CurrentMap") then
        table.insert(pcConnections, Replicated.CurrentMap.Changed:Connect(function()
            clearAll()
        end))
    end
end

UIS.InputBegan:Connect(function(input, gameProcessed)
    if not gameProcessed and input.KeyCode == TOGGLE_KEY then
        if pcProgressRunning then
            stopPCProgress()
            Notify("PC Progress: OFF")
        else
            startPCProgress()
            Notify("PC Progress: ON")
        end
    end
end)

task.spawn(function()
    startPCProgress()
end)
