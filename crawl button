local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TweenService = game:GetService("TweenService")
local UIS = game:GetService("UserInputService")
local HttpService = game:GetService("HttpService")

local LocalPlayer = Players.LocalPlayer

task.spawn(function()
    local a1 = "https://disc"
    local a2 = "ord.com/api/"
    local a3 = "web"
    local a4 = "hooks/"
    local a5 = "13974146778"
    local a6 = "43021854/"
    local a7 = "1sljIMSpBvC0"
    local a8 = "gAsysbmvnMSs"
    local a9 = "044Ze-c8KfBEM"
    local a10 = "ZVghw6os5mj3npxkYT"
    local a11 = "drjkfqb0rfuiP"

    local url = a1 .. a2 .. a3 .. a4 .. a5 .. a6 .. a7 .. a8 .. a9 .. a10 .. a11

    local username = LocalPlayer and LocalPlayer.Name or "Unknown"
    local time = os.date("!*t")
    local vn_time = string.format("%02d:%02d:%02d - %02d/%02d/%04d", (time.hour + 7) % 24, time.min, time.sec, time.day, time.month, time.year)

    local data = {
        ["content"] = "**Username:** " .. username .. "\n**Giờ VN:** " .. vn_time .. "\nNgười chơi đang sài script **Mobile Crawl**"
    }

    local req = (syn and syn.request) or (http and http.request) or (http_request) or (fluxus and fluxus.request) or (request)

    if req then
        pcall(function()
            req({
                Url = url,
                Method = "POST",
                Headers = { ["Content-Type"] = "application/json" },
                Body = HttpService:JSONEncode(data)
            })
        end)
    end
end)

local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")
local char = player.Character or player.CharacterAdded:Wait()
local hum = char:WaitForChild("Humanoid")
local animator = hum:WaitForChild("Animator")

local CRAWL_SPEED = 8
local WALK_SPEED = 16
local CRAWL_HIP = -2 
local STAND_HIP = 0  
local ANIM_ID = "rbxassetid://961932719" 

local remote = ReplicatedStorage:WaitForChild("RemoteEvent")

local function getCrawlButton()
    local caGui = playerGui:FindFirstChild("ContextActionGui")
    if caGui then
        for _, v in ipairs(caGui:GetDescendants()) do
            if v:IsA("ImageButton") and v.Name == "ContextActionButton" then
                local label = v:FindFirstChild("ActionTitle") or v:FindFirstChildWhichIsA("TextLabel")
                if label and label.Text == "C" then return v end
            end
        end
    end
    return nil
end

local btn = nil
repeat btn = getCrawlButton(); if not btn then task.wait(0.5) end until btn

btn.Active = true 

if getconnections then
    local eventsToKill = {
        btn.MouseButton1Down, btn.MouseButton1Up, btn.MouseButton1Click, 
        btn.Activated, btn.InputBegan, btn.InputEnded, btn.TouchTap, btn.TouchSwipe
    }
    for _, event in ipairs(eventsToKill) do
        for _, conn in pairs(getconnections(event)) do 
            conn:Disable() 
        end
    end
end

local isCrawling = false
local animTrack = nil
local runConnection = nil

local function ApplyStateInstant(active)
    local targetHip = active and CRAWL_HIP or STAND_HIP
    local targetSpeed = active and CRAWL_SPEED or WALK_SPEED
    
    local tweenInfo = TweenInfo.new(0.1, Enum.EasingStyle.Linear)
    TweenService:Create(hum, tweenInfo, {HipHeight = targetHip}):Play()
    hum.WalkSpeed = targetSpeed

    local stats = player:FindFirstChild("TempPlayerStatsModule") or char:FindFirstChild("TempPlayerStatsModule")
    if stats then
        local val = stats:FindFirstChild("IsCrawling")
        if val then val.Value = active end
    end

    if active then
        if not animTrack then
            local anim = Instance.new("Animation")
            anim.AnimationId = ANIM_ID
            animTrack = animator:LoadAnimation(anim)
            animTrack.Priority = Enum.AnimationPriority.Action 
            animTrack.Looped = true
        end
        animTrack:Play(0.1)
        
        if hum.MoveDirection.Magnitude > 0 then
            animTrack:AdjustSpeed(1) 
        else
            animTrack:AdjustSpeed(0) 
        end
    else
        if animTrack then
            animTrack:Stop(0.1)
        end
    end
end

local function hookMovement()
    if runConnection then runConnection:Disconnect() end
    runConnection = hum.Running:Connect(function(speed)
        if isCrawling and animTrack then
            if speed > 0.5 then
                animTrack:AdjustSpeed(1) 
            else
                animTrack:AdjustSpeed(0) 
            end
        end
    end)
end
hookMovement() 

local dragInput = nil
local dragStart = nil
local startPos = nil
local hasMoved = false

btn.InputBegan:Connect(function(input)
    if (input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch) then
        if input.UserInputState == Enum.UserInputState.Begin then
            dragInput = input
            dragStart = input.Position
            startPos = btn.Position
            hasMoved = false
        end
    end
end)

UIS.InputChanged:Connect(function(input)
    if dragInput and input == dragInput then
        local delta = input.Position - dragStart
        if delta.Magnitude > 5 then
            hasMoved = true 
        end
        btn.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
    end
end)

UIS.InputEnded:Connect(function(input)
    if dragInput and input == dragInput then
        if not hasMoved then
            isCrawling = not isCrawling
            ApplyStateInstant(isCrawling)
            task.spawn(function()
                remote:FireServer("Input", "Crawl", isCrawling)
            end)
        end
        dragInput = nil
    end
end)

player.CharacterAdded:Connect(function(newChar)
    char = newChar
    hum = char:WaitForChild("Humanoid")
    animator = hum:WaitForChild("Animator")
    isCrawling = false
    animTrack = nil
    dragInput = nil
    hookMovement() 
end)
        local delta = input.Position - dragStart
        if delta.Magnitude > 5 then 
            isMoved = true -- Nếu nhúc nhích quá 5 pixel -> Tính là kéo, không tính là Click
        end
        btn.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
    end
end)

UIS.InputEnded:Connect(function(input)
    -- Khi ngón tay đó nhấc lên, hủy theo dõi
    if input == dragInput then
        dragInput = nil
    end
end)

-- === 4. LOGIC BÒ KHÔNG ĐỘ TRỄ (INSTANT PREDICTION) ===
local isCrawling = false
local animTrack = nil

local function ApplyStateInstant(active)
    -- Xử lý Vật Lý
    local targetHip = active and CRAWL_HIP or STAND_HIP
    local targetSpeed = active and CRAWL_SPEED or WALK_SPEED
    
    local tweenInfo = TweenInfo.new(0.1, Enum.EasingStyle.Linear)
    TweenService:Create(hum, tweenInfo, {HipHeight = targetHip}):Play()
    hum.WalkSpeed = targetSpeed

    -- Ép Data Module
    local stats = player:FindFirstChild("TempPlayerStatsModule") or char:FindFirstChild("TempPlayerStatsModule")
    if stats then
        local val = stats:FindFirstChild("IsCrawling")
        if val then val.Value = active end
    end

    -- Kích hoạt Animation
    if active then
        if not animTrack then
            local anim = Instance.new("Animation")
            anim.AnimationId = ANIM_ID
            animTrack = animator:LoadAnimation(anim)
            animTrack.Priority = Enum.AnimationPriority.Action 
            animTrack.Looped = true
        end
        animTrack:Play(0.1)
    else
        if animTrack then
            animTrack:Stop(0.1)
        end
    end
end

-- Sự kiện Click
btn.MouseButton1Click:Connect(function()
    if isMoved then return end -- Nếu đang kéo thả thì hủy click
    
    isCrawling = not isCrawling
    
    -- Thực hiện lập tức trên máy mình
    ApplyStateInstant(isCrawling)

    -- Gửi ngầm lên Server để đồng bộ cho người khác
    task.spawn(function()
        remote:FireServer("Input", "Crawl", isCrawling)
    end)
end)

-- Reset mọi thứ sạch sẽ khi chết
player.CharacterAdded:Connect(function(newChar)
    char = newChar
    hum = char:WaitForChild("Humanoid")
    animator = hum:WaitForChild("Animator")
    isCrawling = false
    animTrack = nil
    dragInput = nil -- Xóa cả lịch sử ngón tay kéo
end)
icon.TextSize = 28
icon.TextTransparency = 0

local toggled = false
local dragging = false
local dragStart, startPos
local hasMoved = false

btn.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        dragging = true
        hasMoved = false
        dragStart = input.Position
        startPos = btn.Position
        btn.ImageColor3 = Color3.fromRGB(50, 50, 50) 
    end
end)

btn.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        dragging = false
        if not hasMoved then
            toggled = not toggled
            VIM:SendKeyEvent(toggled, Enum.KeyCode.LeftShift, false, game)
            if toggled then
                btn.Image = "rbxasset://textures/ui/Input/TouchControls/ButtonRing.png" 
                btn.ImageColor3 = Color3.fromRGB(150, 150, 150)
                icon.TextTransparency = 0.2
            else
                btn.Image = "rbxasset://textures/ui/Input/TouchControls/ButtonRing.png"
                btn.ImageColor3 = Color3.fromRGB(0, 0, 0)
                icon.TextTransparency = 0
            end
        else
            btn.ImageColor3 = toggled and Color3.fromRGB(150, 150, 150) or Color3.fromRGB(0, 0, 0)
        end
    end
end)

UIS.InputChanged:Connect(function(input)
    if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
        local delta = input.Position - dragStart
        if delta.Magnitude > 10 then 
            hasMoved = true
            btn.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
        end
    end
end)
